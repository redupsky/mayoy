<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8"/>
        <title>Run query...</title>
        <style>
            html,head,body { padding:0; margin:0; }
            body {
                font-family: calibri, helvetica, arial, sans-serif;
                padding: 14px;
            }

            .header {
              height: 35px;
            }

            .header-left {
              float: left;
              min-width: 200px;
            }

            .header-right {
              float: left;
              margin-left: 25px;
            }

            .query {
              clear: both;
            }

            .query .CodeMirror {
              width: 100%;
              height: 106px;
            }

            .query-text {
                display: block;
                margin-bottom: 7px;
                width: 355px;
                height: 100px;
                font-family: monospace;
                font-size: 13px;
                //visibility: hidden;
            }

            .results-table {
                margin-top: 20px;
            }

          .status {
            background-color: #eee;
            color: #888;
            font-size: 13px;
            line-height: 21px;
            padding: 0 7px;
            border-radius: 3px;
            display: inline-block;
          }

        </style>
        <script src="node_modules/codemirror/lib/codemirror.js" type="text/javascript"></script>
        <script src="node_modules/codemirror/mode/sql/sql.js" type="text/javascript"></script>
        <link rel="stylesheet" href="node_modules/codemirror/lib/codemirror.css"/>
    </head>
    <body>
        <script type="text/javascript">

          let Elm = require("./juxta");

          let app = Elm.Juxta.fullscreen();

          let mysql = require("mysql");

          let packets = require("mysql/lib/protocol/packets");

          let connection;

          app.ports.connect.subscribe(params => {
            connection = mysql.createConnection(
              {
                host: params.hostAndPort[0],
                port: params.hostAndPort[1],
                user: params.user,
                password: params.password,
                database: params.database
              }
            );

            connection.connect(error => {
              if (error) {
                app.ports.connectionFailed.send(error.message);
                return;
              }

              app.ports.connectionEstablished.send([params, connection.threadId]);
            });
          });

          app.ports.close.subscribe(threadId => {
            connection.end(error => {
              if (error) {
                app.ports.closeConnectionFailed.send([threadId, error.message]);
                return;
              }

              app.ports.connectionClosed.send(threadId);
            });
          });

          app.ports.runQuery.subscribe(([threadId, sql]) => {
            let query = connection.query(sql);

            query.on("error", error => app.ports.queryFailed.send([threadId, error.message]));

            query.on(
              "fields",
              fields => app.ports.receiveColumns.send(
                [
                  threadId,
                  fields.map(field => new Object({name: field.name, typeNum: field.type, length: field.length}))
                ]
              )
            );

            query.on("result", packet => {
              if (packet instanceof packets.RowDataPacket) {

                let columns = Object.getOwnPropertyNames(packet);

                let row = [];

                for (let column of columns) {
                  let value = packet[column];
                  row.push([column, value !== null && value !== undefined ? String(value) : ""]);
                }

                app.ports.receiveRow.send([threadId, row]);
              }
            });

            query.on("end", () => app.ports.receiveEnd.send(threadId));
          });

          app.ports.runCodemirror.subscribe(id => {

              let observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                  if (mutation.addedNodes.length > 0 && mutation.addedNodes[0].nodeName === "MAIN") {

                    observer.disconnect();

                    let editor = CodeMirror.fromTextArea(document.getElementById(id), {lineNumbers: true, mode: "sql"});

                    editor.setOption("extraKeys", {
                      "Cmd-R": () => app.ports.pressRunInCodemirror.send("")
                    });

                    app.ports.requestTextFromCodemirror.subscribe(() => {
                      app.ports.receiveTextFromCodemirror.send(editor.getValue());
                    });
                  }
                });
              });

              observer.observe(document.body, {childList: true, characterData: true, subtree: true});
            });


        </script>
    </body>
</html>
